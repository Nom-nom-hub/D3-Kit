---
description: Clarify underspecified areas in the D3 specification before proceeding to planning.
handoffs:
  - label: Build Technical Plan
    agent: d3.plan
    prompt: Create a plan for the spec. I am building with...
  - label: Update Specification
    agent: d3.spec
    prompt: Refine the specification with the new clarifications
    send: true
scripts:
  sh: scripts/bash/check-d3-spec.sh --json
  ps: scripts/powershell/check-d3-spec.ps1 -Json
---

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

## Outline

The user input after `/d3.clarify` contains specific areas that need clarification or the command is used without arguments to identify all unclear areas in the current specification.

Given the current spec in `d3-features/[current-branch]/spec.md`, do this:

1. **Setup**: Run `{SCRIPT}` from repo root and parse JSON for CURRENT_SPEC_PATH and FEATURE_DIR.

2. **Load specification**: Read the current specification file and identify all [CLARIFY] markers.

3. **If user provided specific clarifications in `$ARGUMENTS`**:
   - Identify which [CLARIFY] items the user is addressing
   - Replace the [CLARIFY] markers with the user's clarifications
   - Validate that the specification now has fewer [CLARIFY] markers

4. **If no user input was provided** (default clarifications):
   - Extract all [CLARIFY: ...] markers from the specification
   - For each clarification needed, present options to user in this format:

      ```markdown
      ## Question [N]: [Topic]

      **Context**: [Quote relevant spec section]

      **What we need to know**: [Specific question from CLARIFY marker]

      **Suggested Answers**:

      | Option | Answer | Implications |
      |--------|--------|--------------|
      | A      | [First suggested answer] | [What this means for the feature] |
      | B      | [Second suggested answer] | [What this means for the feature] |
      | C      | [Third suggested answer] | [What this means for the feature] |
      | Custom | Provide your own answer | [Explain how to provide custom input] |

      **Your choice**: _[Wait for user response]_
      ```

   - **CRITICAL - Table Formatting**: Ensure markdown tables are properly formatted with proper spacing
   - Number questions sequentially (Q1, Q2, Q3, etc.)
   - Present all questions together before waiting for responses
   - Wait for user to respond with their choices for all questions (e.g., "Q1: A, Q2: Custom - [details], Q3: B")
   - Update the spec by replacing each [CLARIFY] marker with the user's selected or provided answer

5. **Validate specification completeness**: After all clarifications are resolved:
   - Confirm there are no remaining [CLARIFY] markers in the spec
   - Verify that all coding slices have clear acceptance scenarios
   - Ensure developer intent is clearly reflected in each slice
   - Check that success criteria are measurable and achievable

6. **Update the specification file** with resolved clarifications.

7. **Report completion**: Output the path of the updated specification and confirm that clarifications have been resolved.

## D3-Kit Focus Areas

- **Developer Intent**: Ensure clarifications align with the original developer intent
- **Coding Slices**: Verify each slice remains independently testable after clarifications
- **AI-Readability**: Keep clarifications clear and unambiguous for AI processing
- **Parallelization Readiness**: Ensure clarifications don't impede potential parallel exploration

## Key Guidelines

- Maintain focus on developer intent and coding slice independence
- Keep all clarifications traceable back to original requirements
- Ensure all clarified items support the overall feature success criteria
- Preserve the slice-based architecture approach